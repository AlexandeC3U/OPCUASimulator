# Telegraf Configuration for SORT3 Simulator
# Collects OPC UA data and sends to InfluxDB

[global_tags]
  workcenter = "SORT3"

[agent]
  interval = "1s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "1s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = "sort3-telegraf"
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "sort3-super-secret-token"
  organization = "decospan"
  bucket = "sort3"

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# OPC UA Client Input Plugin
[[inputs.opcua]]
  name = "sort3_opcua"
  endpoint = "opc.tcp://opcua-simulator:4840/freeopcua/server/"
  connect_timeout = "10s"
  request_timeout = "5s"
  security_policy = "None"
  security_mode = "None"
  
  # Node configuration using the group format
  [[inputs.opcua.group]]
    name = "veneer_stacked"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="OUT_BOXFULL", identifier="OUT_BOXFULL"},
      {name="OUT_BOXNR", identifier="OUT_BOXNR"},
      {name="OUT_LPN_ID", identifier="OUT_LPN_ID"},
      {name="OUT_LPN_QTY", identifier="OUT_LPN_QTY"},
      {name="OUT_OBJT_VALUE_PROCESSED", identifier="OUT_OBJT_VALUE_PROCESSED"},
      {name="OUT_PLC_NEW_VALUE", identifier="OUT_PLC_NEW_VALUE"},
      {name="OUT_REPAIR", identifier="OUT_REPAIR"},
      {name="OUT_PO_ID", identifier="OUT_PO_ID"},
    ]

  [[inputs.opcua.group]]
    name = "started_po"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_OBJT_NEW_VALUE", identifier="SRT_OBJT_NEW_VALUE"},
      {name="SRT_PLC_VALUE_PROCESSED", identifier="SRT_PLC_VALUE_PROCESSED"},
      {name="SRT_PO_ID", identifier="SRT_PO_ID"},
      {name="SRT_PO_QTY", identifier="SRT_PO_QTY"},
      {name="ORDER_STATUS", identifier="ORDER_STATUS"},
    ]

  [[inputs.opcua.group]]
    name = "custom_attributes"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_SPEEDBELTTRANSPORT", identifier="SRT_SPEEDBELTTRANSPORT"},
      {name="SRT_MAXSHEETSBOX", identifier="SRT_MAXSHEETSBOX"},
      {name="SRT_OPENBOXDISTNACE", identifier="SRT_OPENBOXDISTNACE"},
    ]

  [[inputs.opcua.group]]
    name = "block_output"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="BB_BOX_BLOCK", identifier="BB_BOX_BLOCK"},
      {name="BB_CUTTING", identifier="BB_CUTTING"},
      {name="BB_ITEMNAME", identifier="BB_ITEMNAME"},
      {name="BB_OBJT_NEW_VALUE", identifier="BB_OBJT_NEW_VALUE"},
      {name="BB_OUT_BOXNR", identifier="BB_OUT_BOXNR"},
      {name="BB_PLC_VALUE_PROCESSED", identifier="BB_PLC_VALUE_PROCESSED"},
      {name="BB_TAPE", identifier="BB_TAPE"},
      {name="BB_VENEER_L", identifier="BB_VENEER_L"},
    ]

  [[inputs.opcua.group]]
    name = "srt_station_1"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_1_ACTIVE", identifier="SRT_1_ACTIVE"},
      {name="SRT_1_QTY", identifier="SRT_1_QTY"},
      {name="SRT_1_ITEMNAME", identifier="SRT_1_ITEMNAME"},
      {name="SRT_1_CUTTING", identifier="SRT_1_CUTTING"},
      {name="SRT_1_TAPE", identifier="SRT_1_TAPE"},
      {name="SRT_1_VENEER_L", identifier="SRT_1_VENEER_L"},
    ]

  [[inputs.opcua.group]]
    name = "srt_station_2"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_2_ACTIVE", identifier="SRT_2_ACTIVE"},
      {name="SRT_2_QTY", identifier="SRT_2_QTY"},
      {name="SRT_2_ITEMNAME", identifier="SRT_2_ITEMNAME"},
      {name="SRT_2_CUTTING", identifier="SRT_2_CUTTING"},
      {name="SRT_2_TAPE", identifier="SRT_2_TAPE"},
      {name="SRT_2_VENEER_L", identifier="SRT_2_VENEER_L"},
    ]

  [[inputs.opcua.group]]
    name = "srt_station_3"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_3_ACTIVE", identifier="SRT_3_ACTIVE"},
      {name="SRT_3_QTY", identifier="SRT_3_QTY"},
      {name="SRT_3_ITEMNAME", identifier="SRT_3_ITEMNAME"},
      {name="SRT_3_CUTTING", identifier="SRT_3_CUTTING"},
      {name="SRT_3_TAPE", identifier="SRT_3_TAPE"},
      {name="SRT_3_VENEER_L", identifier="SRT_3_VENEER_L"},
    ]

  [[inputs.opcua.group]]
    name = "srt_station_4"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_4_ACTIVE", identifier="SRT_4_ACTIVE"},
      {name="SRT_4_QTY", identifier="SRT_4_QTY"},
      {name="SRT_4_ITEMNAME", identifier="SRT_4_ITEMNAME"},
      {name="SRT_4_CUTTING", identifier="SRT_4_CUTTING"},
      {name="SRT_4_TAPE", identifier="SRT_4_TAPE"},
      {name="SRT_4_VENEER_L", identifier="SRT_4_VENEER_L"},
    ]

  [[inputs.opcua.group]]
    name = "srt_station_5"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_5_ACTIVE", identifier="SRT_5_ACTIVE"},
      {name="SRT_5_QTY", identifier="SRT_5_QTY"},
      {name="SRT_5_ITEMNAME", identifier="SRT_5_ITEMNAME"},
      {name="SRT_5_CUTTING", identifier="SRT_5_CUTTING"},
      {name="SRT_5_TAPE", identifier="SRT_5_TAPE"},
      {name="SRT_5_VENEER_L", identifier="SRT_5_VENEER_L"},
    ]

  [[inputs.opcua.group]]
    name = "srt_station_6"
    namespace = "2"
    identifier_type = "s"
    nodes = [
      {name="SRT_6_ACTIVE", identifier="SRT_6_ACTIVE"},
      {name="SRT_6_QTY", identifier="SRT_6_QTY"},
      {name="SRT_6_ITEMNAME", identifier="SRT_6_ITEMNAME"},
      {name="SRT_6_CUTTING", identifier="SRT_6_CUTTING"},
      {name="SRT_6_TAPE", identifier="SRT_6_TAPE"},
      {name="SRT_6_VENEER_L", identifier="SRT_6_VENEER_L"},
    ]

# Also subscribe to MQTT for events
[[inputs.mqtt_consumer]]
  servers = ["tcp://emqx:1883"]
  topics = [
    "menen/sort3/status/#"
  ]
  qos = 0
  data_format = "json"
  topic_tag = "topic"
  json_string_fields = ["event", "data_po_id", "data_lpn_id"]
